<%= changeMainView "welcome" %>

$('.banner').hide();
$('.points-view').hide();
$('.footer').hide();
$('#main-content').css({'padding-bottom': '0'});


var formInProgress = false;

$(document).off('submit.signin').on('submit.signin','#reg-signin-form', onFormSubmit);
function onFormSubmit() {

    formInProgress = true;

    var valuesToSubmit = $(this).serialize();
    $.ajax({
        type: 'GET',
        url: $(this).attr('action'), //submits it to the given url of the form
        data: valuesToSubmit,
        dataType: "JSON", // you want a difference between normal and ajax-calls, and json is standard

        complete: function (data, textStatus) {
            // request completed

            if ($('#reg_code').length > 0) {
                // main content has been changed
                window.loadRemoteScript = false;
                History.pushState({}, '', '/sign_up' + '?reg_code=' + $('#reg_code').val());
            }
            formInProgress = false;
        }
    });

    return false; // prevents normal behaviour
}

$('.main a').click(function (e) {
    window.loadRemoteScript = false;
    History.pushState({}, '', $(this).attr('href'));
});

$('#email-signup').click(function(e) {
    e.preventDefault();
    if (formInProgress) return false; // abort multiple clicks

    $(this).closest('form').submit();
    return false;
});
$('#reg-with-facebook').click(function(e) {
    e.preventDefault();
    if (formInProgress) return false; // abort multiple clicks

    var input = $("<input>")
            .attr("type", "hidden")
            .attr("name", "facebook").val("");

    $(this).closest('form').append($(input)).submit();
    return false;
});

showRegOptions();
$('#code-field').on('keyup', showRegOptions);
var lastValue = '';
$('#code-field').on('keyup', function() {
    if (lastValue != this.value && /[a-z]/.test(this.value)) {
        // If there's a change in string and lowercase letters has been typed
        // Change string to uper case
        this.value = this.value.toUpperCase();
    }
    lastValue = this.value;
});

function showRegOptions() {
    if ($('#code-field').val().length > 6) {
        //$('#reg-options').css('visibility', 'visible');
        $.ajax({
            url: "<%= player_check_reg_code_path %>" + '?reg_code=' + $('#code-field').val(),
            dataType: "json",
            type: "GET",
            processData: false,
            contentType: "application/json",
            success: function(data){
//                alert(data['valid']);
                if (data['valid']) {
                    $('#reg-options').css({display: 'inline-block'});
                    $('.error-msg').css({visibility: 'hidden'});
//                    $('#code-field').hide();
                } else {
                    $('#reg-options').hide();
                    $('.error-msg').css({visibility: 'visible'});
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log("Status: " + textStatus + "; Error: " + errorThrown);
            }
        });
        //$('#reg-signin-form').css({'height': '220px', marginBottom: '0' });
    } else {
        $('#reg-options').hide();
        $('.error-msg').css({visibility: 'hidden'});
        //$('#reg-signin-form').css({'height': '190px', marginBottom: '30px' });
    }
}